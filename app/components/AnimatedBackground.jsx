import React, { Component } from 'react';
import PropTypes from 'prop-types';
import styled from 'styled-components';

import Scene from './webgl/Scene';
import Camera from './webgl/Camera';
import Vbo from './webgl/Vbo';
import Objet from './webgl/Objet';
import Program from './webgl/Program';
import Primitive from './webgl/Primitive';
import Loop from './webgl/Loop';
import Fbo from './webgl/Fbo';
import Texture from './webgl/Texture';
import Mat4 from './geometry/Mat4';

import ParseObj from '../utils/ParseObj';
import basique from '../shaders/basique';
import shader from '../shaders/glitch';


const Styled = styled.div`
width: 100%;
text-align: center;

canvas {
  margin: 0 auto;
  width: ${p => p.width}px;
  height: ${p => p.height}px;
}
`;

class AnimatedBackground extends Component {
  constructor(props) {
    super(props);

    this.width = 600;
    this.height = 600;

    const p = new ParseObj();
    p.setup(test);

    this.points = p.getVerticesList();
    this.objets = p.getObjets();

    // this.objets = this.objets.slice(1, 2);

    this.models = new Array(this.objets.length);
    for (let i = 0; i < this.models.length; i++) {
      this.models[i] = new Mat4();
      this.models[i].identity();
    }

    this.state = { cpt: 0 };
    this.onAnimate = this.onAnimate.bind(this);
  }

  // shouldComponentUpdate() {
  //   return false;
  // }


  onAnimate() {
    for (let i = 0; i < this.models.length; i++) {
      const variant = Math.cos(this.state.cpt * 0.05) * ((i - (this.models.length / 2)) * 0.1);
      this.models[i].identity();
      this.models[i].rotate(this.state.cpt, 0,1,0);
      // this.models[i].translate(0, 0, variant);
    }
    // this.cpt++;
    this.setState((prevState) => ({
      cpt: prevState.cpt + 1,
    }));
  }


  render() {
    return (<Styled
      width={this.width}
      height={this.height}
    >
      <Scene
        width={this.width}
        height={this.height}
      >
        <Loop onAnimate={this.onAnimate}>
          <Camera
            width={this.width}
            height={this.height}
            position={[-15, 0, 0]}
            angle={40}
          >
            <Program
              vertex={basique.vertex}
              fragment={basique.fragment}
            >
              <Vbo points={this.points}>
                {this.objets.map((obj, idx) => (
                  <Objet
                    key={obj.key}
                    indices={obj.vID}
                    mode="LINE_LOOP"
                    model={this.models[idx].get()}
                    color={[102/255, 1, 204/255, 1]}
                  />
                ))}
              </Vbo>
            </Program>
          </Camera>

          <Program
            vertex={shader.vertex}
            fragment={shader.fragment}
            time={this.state.cpt}
            amplitude={0.05}
          >
            <Fbo
              width={this.width}
              height={this.height}
            >
              <Texture
                id={1}
                width={1024}
                height={1024}
              >
                <Primitive
                  color={[102/255, 1, 204/255, 1]}
                />
              </Texture>
            </Fbo>
          </Program>
        </Loop>
      </Scene>
    </Styled>);
  }
}

AnimatedBackground.propTypes = {
};

AnimatedBackground.defaultProps = {};

export default AnimatedBackground;

const test = `
# Blender v2.79 (sub 0) OBJ File: 'walkman2.blend'
# www.blender.org
o Cube.019
v 0.091529 1.157520 -1.266488
v 0.091529 1.157520 -0.999024
v -0.069741 1.157520 -0.999024
v -0.069741 1.157520 -1.266488
s off
f 1 4 3 2
o Cube.018
v 0.091529 0.909476 -0.999024
v -0.069741 0.909476 -0.999024
v 0.091529 1.157520 -0.999024
v -0.069741 1.157520 -0.999024
s off
f 5 7 8 6
o Cube.017
v 0.091529 0.909476 -1.266488
v -0.069741 0.909476 -1.266488
v 0.091529 1.157520 -1.266488
v -0.069741 1.157520 -1.266488
s off
f 11 9 10 12
o Cube.016
v 0.091529 1.157520 -0.860161
v 0.091529 1.157520 -0.592698
v -0.069741 1.157520 -0.592698
v -0.069741 1.157520 -0.860161
s off
f 13 16 15 14
o Cube.015
v 0.091529 0.909476 -0.592698
v -0.069741 0.909476 -0.592698
v 0.091529 1.157520 -0.592698
v -0.069741 1.157520 -0.592698
s off
f 17 19 20 18
o Cube.014
v 0.091529 0.909476 -0.860161
v -0.069741 0.909476 -0.860161
v 0.091529 1.157520 -0.860161
v -0.069741 1.157520 -0.860161
s off
f 23 21 22 24
o Cube.013
v 0.091529 1.157520 -0.453835
v 0.091529 1.157520 -0.186371
v -0.069741 1.157520 -0.186371
v -0.069741 1.157520 -0.453835
s off
f 25 28 27 26
o Cube.012
v 0.091529 0.909476 -0.186371
v -0.069741 0.909476 -0.186371
v 0.091529 1.157520 -0.186371
v -0.069741 1.157520 -0.186371
s off
f 29 31 32 30
o Cube.011
v 0.091529 0.909476 -0.453835
v -0.069741 0.909476 -0.453835
v 0.091529 1.157520 -0.453835
v -0.069741 1.157520 -0.453835
s off
f 35 33 34 36
o Cylinder.031_Cylinder.037
v -0.228049 0.094044 -0.921450
v -0.200846 0.094044 -0.921450
v -0.228049 0.001357 -1.014138
v -0.200846 0.001357 -1.014138
s off
f 37 38 40 39
o Cylinder.030_Cylinder.036
v -0.228049 0.001357 -0.828762
v -0.200846 0.001357 -0.828762
v -0.228049 0.094044 -0.921450
v -0.200846 0.094044 -0.921450
s off
f 41 42 44 43
o Cylinder.029_Cylinder.035
v -0.228049 -0.091331 -0.921450
v -0.200846 -0.091331 -0.921450
v -0.228049 0.001357 -1.014138
v -0.200846 0.001357 -1.014138
s off
f 47 48 46 45
o Cylinder.028_Cylinder.034
v -0.284715 0.001888 -1.455935
v -0.143764 0.001888 -1.455935
v -0.284715 -0.375835 -1.299477
v -0.143764 -0.375835 -1.299477
s off
f 49 50 52 51
o Cylinder.027_Cylinder.033
v -0.284715 0.379611 -1.299477
v -0.143764 0.379611 -1.299477
v -0.284715 0.001888 -1.455935
v -0.143764 0.001888 -1.455935
s off
f 53 54 56 55
o Cylinder.026_Cylinder.032
v -0.284715 0.536069 -0.921754
v -0.143764 0.536069 -0.921754
v -0.284715 0.379611 -1.299477
v -0.143764 0.379611 -1.299477
s off
f 57 58 60 59
o Cylinder.025_Cylinder.031
v -0.284715 0.379611 -0.544030
v -0.143764 0.379611 -0.544030
v -0.284715 0.536069 -0.921754
v -0.143764 0.536069 -0.921754
s off
f 61 62 64 63
o Cylinder.024_Cylinder.030
v -0.284715 0.001888 -0.387572
v -0.143764 0.001888 -0.387572
v -0.284715 0.379611 -0.544030
v -0.143764 0.379611 -0.544030
s off
f 65 66 68 67
o Cylinder.023_Cylinder.029
v -0.284715 -0.375836 -0.544030
v -0.143764 -0.375836 -0.544030
v -0.284715 0.001888 -0.387572
v -0.143764 0.001888 -0.387572
s off
f 69 70 72 71
o Cylinder.022_Cylinder.028
v -0.284715 -0.532294 -0.921754
v -0.143764 -0.532294 -0.921754
v -0.284715 -0.375835 -1.299477
v -0.143764 -0.375835 -1.299477
s off
f 75 76 74 73
o Cylinder.021_Cylinder.027
v -0.228049 0.094044 0.232279
v -0.200846 0.094044 0.232279
v -0.228049 0.001357 0.139591
v -0.200846 0.001357 0.139591
s off
f 77 78 80 79
o Cylinder.020_Cylinder.026
v -0.228049 0.001357 0.324967
v -0.200846 0.001357 0.324967
v -0.228049 0.094044 0.232279
v -0.200846 0.094044 0.232279
s off
f 81 82 84 83
o Cylinder.019_Cylinder.025
v -0.228049 -0.091331 0.232279
v -0.200846 -0.091331 0.232279
v -0.228049 0.001357 0.139591
v -0.200846 0.001357 0.139591
s off
f 87 88 86 85
o Cylinder.018_Cylinder.024
v -0.284715 0.001888 -0.302225
v -0.143764 0.001888 -0.302225
v -0.284715 -0.375835 -0.145767
v -0.143764 -0.375835 -0.145767
s off
f 89 90 92 91
o Cylinder.017_Cylinder.023
v -0.284715 0.379611 -0.145767
v -0.143764 0.379611 -0.145767
v -0.284715 0.001888 -0.302225
v -0.143764 0.001888 -0.302225
s off
f 93 94 96 95
o Cylinder.016_Cylinder.022
v -0.284715 0.536069 0.231957
v -0.143764 0.536069 0.231957
v -0.284715 0.379611 -0.145767
v -0.143764 0.379611 -0.145767
s off
f 97 98 100 99
o Cylinder.015_Cylinder.021
v -0.284715 0.379611 0.609680
v -0.143764 0.379611 0.609680
v -0.284715 0.536069 0.231957
v -0.143764 0.536069 0.231957
s off
f 101 102 104 103
o Cylinder.014_Cylinder.020
v -0.284715 0.001888 0.766138
v -0.143764 0.001888 0.766138
v -0.284715 0.379611 0.609680
v -0.143764 0.379611 0.609680
s off
f 105 106 108 107
o Cylinder.013_Cylinder.019
v -0.284715 -0.375836 0.609680
v -0.143764 -0.375836 0.609680
v -0.284715 0.001888 0.766138
v -0.143764 0.001888 0.766138
s off
f 109 110 112 111
o Cylinder.012_Cylinder.018
v -0.284715 -0.532294 0.231957
v -0.143764 -0.532294 0.231957
v -0.284715 -0.375835 -0.145767
v -0.143764 -0.375835 -0.145767
s off
f 115 116 114 113
o Cube.010
v 0.174998 0.795160 -1.885592
v 0.174998 0.795160 1.052465
v -0.566358 0.795160 1.052463
v -0.566357 0.795160 -1.885593
s off
f 117 120 119 118
o Cube.009
v 0.174998 -0.795160 1.052464
v -0.566357 -0.795160 1.052464
v 0.174998 0.795160 1.052465
v -0.566358 0.795160 1.052463
s off
f 121 123 124 122
o Cube.008
v 0.174998 -0.795160 -1.885592
v -0.566357 -0.795160 -1.885593
v 0.174998 0.795160 -1.885592
v -0.566357 0.795160 -1.885593
s off
f 127 125 126 128
o Cube.007
v 0.385293 1.000000 -1.659334
v 0.385293 1.000000 1.659336
v -0.385293 1.000000 1.659335
v -0.385293 1.000000 -1.659335
s off
f 129 132 131 130
o Cube.006_Cube.003
v 0.385293 -1.000000 1.659335
v -0.385293 -1.000000 1.659335
v 0.385293 1.000000 1.659336
v -0.385293 1.000000 1.659335
s off
f 133 135 136 134
o Cube.005_Cube.002
v 0.385293 -1.000000 -1.659335
v -0.385293 -1.000000 -1.659336
v 0.385293 1.000000 -1.659334
v -0.385293 1.000000 -1.659335
s off
f 139 137 138 140
o Cylinder.011_Cylinder.017
v -0.027690 -0.583185 2.032909
v -0.027690 -0.583185 1.240898
v -0.056686 -0.672427 2.032909
v -0.056686 -0.672427 1.240898
s off
f 141 142 144 143
o Cylinder.010_Cylinder.016
v 0.066144 -0.583185 2.032909
v 0.066144 -0.583185 1.240898
v -0.027690 -0.583185 2.032909
v -0.027690 -0.583185 1.240898
s off
f 145 146 148 147
o Cylinder.009_Cylinder.015
v 0.095141 -0.672427 2.032909
v 0.095141 -0.672427 1.240898
v 0.066144 -0.583185 2.032909
v 0.066144 -0.583185 1.240898
s off
f 149 150 152 151
o Cylinder.008_Cylinder.014
v 0.019227 -0.727581 2.032909
v 0.019227 -0.727581 1.240898
v -0.056686 -0.672427 2.032909
v -0.056686 -0.672427 1.240898
s off
f 155 156 154 153
o Cylinder.005_Cylinder.013
v 0.060427 -0.621554 4.196342
v 0.060427 -0.621554 1.846573
v -0.022749 -0.621554 4.196342
v -0.022749 -0.621554 1.846573
s off
f 157 158 160 159
o Cylinder.002_Cylinder.012
v 0.018839 -0.693586 4.196342
v 0.018839 -0.693586 1.846573
v -0.022749 -0.621554 4.196342
v -0.022749 -0.621554 1.846573
s off
f 163 164 162 161
o Cylinder.001_Cylinder.010
v -0.228049 -0.091331 0.232279
v -0.228049 0.001357 0.324967
v -0.200846 0.001357 0.324967
v -0.200846 -0.091331 0.232279
s off
f 165 168 167 166
o Cylinder_Cylinder.004
v 0.019227 -0.727581 2.032909
v 0.095141 -0.672427 2.032909
v 0.095141 -0.672427 1.240898
v 0.019227 -0.727581 1.240898
s off
f 169 172 171 170
o Cylinder.006_Cylinder
v 0.018839 -0.693586 4.196342
v 0.060427 -0.621554 4.196342
v 0.060427 -0.621554 1.846573
v 0.018839 -0.693586 1.846573
s off
f 173 176 175 174
o Cube
v 0.385293 -1.000000 -1.659335
v 0.385293 -1.000000 1.659335
v -0.385293 -1.000000 -1.659336
v -0.385293 -1.000000 1.659335
s off
f 177 178 180 179
o Cube.001
v 0.174998 -0.795160 -1.885592
v 0.174998 -0.795160 1.052464
v -0.566357 -0.795160 -1.885593
v -0.566357 -0.795160 1.052464
s off
f 181 182 184 183
o Cube.004
v 0.091529 0.909476 -0.860161
v 0.091529 0.909476 -0.592698
v -0.069741 0.909476 -0.860161
v -0.069741 0.909476 -0.592698
s off
f 185 186 188 187
o Cube.002_Cube.005
v 0.091529 0.909476 -1.266488
v 0.091529 0.909476 -0.999024
v -0.069741 0.909476 -1.266488
v -0.069741 0.909476 -0.999024
s off
f 189 190 192 191
o Cube.003_Cube.006
v 0.091529 0.909476 -0.453835
v 0.091529 0.909476 -0.186371
v -0.069741 0.909476 -0.453835
v -0.069741 0.909476 -0.186371
s off
f 193 194 196 195
o Cylinder.003_Cylinder.005
v -0.284715 -0.532294 0.231957
v -0.284715 -0.375836 0.609680
v -0.143764 -0.375836 0.609680
v -0.143764 -0.532294 0.231957
s off
f 197 200 199 198
o Cylinder.004_Cylinder.007
v -0.284715 -0.532294 -0.921754
v -0.284715 -0.375836 -0.544030
v -0.143764 -0.375836 -0.544030
v -0.143764 -0.532294 -0.921754
s off
f 201 204 203 202
o Cylinder.007_Cylinder.011
v -0.228049 -0.091331 -0.921450
v -0.228049 0.001357 -0.828762
v -0.200846 0.001357 -0.828762
v -0.200846 -0.091331 -0.921450
s off
f 205 208 207 206
`;