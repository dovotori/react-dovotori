import React, { Component } from 'react';
import PropTypes from 'prop-types';
import styled from 'styled-components';

import Scene from './webgl/Scene';
import Camera from './webgl/Camera';
import Vbo from './webgl/Vbo';
import Objet from './webgl/Objet';
import Program from './webgl/Program';
import Primitive from './webgl/Primitive';
import Loop from './webgl/Loop';
import Fbo from './webgl/Fbo';
import Texture from './webgl/Texture';
import Mat4 from './geometry/Mat4';

import ParseObj from '../utils/ParseObj';
import basique from '../shaders/basique';
import shader from '../shaders/glitch';


const Styled = styled.div`
width: 100%;
text-align: center;

canvas {
  margin: 0 auto;
  width: ${p => p.width}px;
  height: ${p => p.height}px;
}
`;

class AnimatedBackground extends Component {
  constructor(props) {
    super(props);

    this.width = 600;
    this.height = 600;

    const p = new ParseObj();
    p.setup(test);

    this.points = p.getVerticesList();
    this.objets = p.getObjets();

    // this.objets = this.objets.slice(0, 1);

    this.models = new Array(this.objets.length);
    for (let i = 0; i < this.models.length; i++) {
      this.models[i] = new Mat4();
      this.models[i].identity();
    }

    this.cpt = 0;
    this.onAnimate = this.onAnimate.bind(this);
  }

  shouldComponentUpdate() {
    return false;
  }

  onAnimate() {
    this.cpt++;
    for (let i = 0; i < this.models.length; i++) {
      const variant = Math.cos(this.cpt * 0.1) * ((i - (this.models.length / 2)) * 0.4);
      this.models[i].identity();
      this.models[i].rotate(this.cpt, 0,1,0);
      // this.models[i].translate(0, variant, 0);
    }
  }


  render() {
    return (<Styled
      width={this.width}
      height={this.height}
    >
      <Scene
        width={this.width}
        height={this.height}
      >
        <Loop onAnimate={this.onAnimate}>
          <Camera
            width={this.width}
            height={this.height}
          >
            <Program
              vertex={basique.vertex}
              fragment={basique.fragment}
            >
              <Vbo points={this.points}>
                {this.objets.map((obj, idx) => (
                  <Objet
                    key={obj.key}
                    indices={obj.vID}
                    mode="LINE_LOOP"
                    model={this.models[idx].get()}
                    color={[102/255, 1, 204/255, 1]}
                  />
                ))}
              </Vbo>
            </Program>
          </Camera>

          <Program
            vertex={shader.vertex}
            fragment={shader.fragment}
          >
            <Fbo
              width={this.width}
              height={this.height}
            >
              <Texture
                id={1}
                width={1024}
                height={1024}
              >
                <Primitive
                  color={[102/255, 1, 204/255, 1]}
                />
              </Texture>
            </Fbo>
          </Program>
        </Loop>
      </Scene>
    </Styled>);
  }
}

AnimatedBackground.propTypes = {
};

AnimatedBackground.defaultProps = {};

export default AnimatedBackground;

const test = `
# Blender v2.79 (sub 0) OBJ File: 'walkman.blend'
# www.blender.org
o Cylinder_Cylinder.002
v -0.036440 -0.124574 0.670006
v -0.036440 -0.124574 0.438688
v -0.020693 -0.118052 0.670006
v -0.020693 -0.118052 0.438688
v -0.014171 -0.102305 0.670006
v -0.014171 -0.102305 0.438688
v -0.020693 -0.086558 0.670006
v -0.020693 -0.086558 0.438688
v -0.036440 -0.080036 0.670006
v -0.036440 -0.080036 0.438688
v -0.052187 -0.086558 0.670006
v -0.052187 -0.086559 0.438688
v -0.058709 -0.102305 0.670006
v -0.058709 -0.102305 0.438688
v -0.052187 -0.118052 0.670006
v -0.052187 -0.118052 0.438688
s off
f 2 3 1
f 4 5 3
f 6 7 5
f 7 10 9
f 10 11 9
f 12 13 11
f 12 10 6
f 14 15 13
f 16 1 15
f 7 13 15
f 2 4 3
f 4 6 5
f 6 8 7
f 7 8 10
f 10 12 11
f 12 14 13
f 6 4 2
f 2 16 6
f 14 12 6
f 10 8 6
f 6 16 14
f 14 16 15
f 16 2 1
f 15 1 7
f 3 5 7
f 7 9 11
f 11 13 7
f 1 3 7
o Cube
v 0.076782 -0.192677 -0.445311
v 0.076782 -0.192677 0.554245
v -0.155312 -0.192677 0.554245
v -0.155312 -0.192677 -0.445311
v 0.076782 0.409707 -0.445311
v 0.076782 0.409707 0.554246
v -0.155312 0.409707 0.554245
v -0.155312 0.409707 -0.445311
s off
f 17 19 20
f 21 23 22
f 21 18 17
f 22 19 18
f 23 20 19
f 17 24 21
f 17 18 19
f 21 24 23
f 21 22 18
f 22 23 19
f 23 24 20
f 17 20 24
o Cube.001
v 0.008150 -0.130981 -0.445468
v 0.008150 -0.130981 0.349339
v -0.176402 -0.130981 0.349339
v -0.176402 -0.130981 -0.445468
v 0.008150 0.348010 -0.445468
v 0.008150 0.348010 0.349339
v -0.176402 0.348010 0.349339
v -0.176402 0.348010 -0.445468
s off
f 25 27 28
f 29 31 30
f 29 26 25
f 30 27 26
f 27 32 28
f 25 32 29
f 25 26 27
f 29 32 31
f 29 30 26
f 30 31 27
f 27 31 32
f 25 28 32
o Cube.004
v -0.013676 0.382441 -0.204606
v -0.013676 0.382441 -0.124049
v -0.062249 0.382441 -0.124049
v -0.062249 0.382441 -0.204606
v -0.013676 0.457150 -0.204606
v -0.013676 0.457150 -0.124049
v -0.062249 0.457150 -0.124049
v -0.062249 0.457150 -0.204606
s off
f 34 36 33
f 37 39 38
f 37 34 33
f 38 35 34
f 39 36 35
f 33 40 37
f 34 35 36
f 37 40 39
f 37 38 34
f 38 39 35
f 39 40 36
f 33 36 40
o Cube.002_Cube.005
v -0.013676 0.382441 -0.326989
v -0.013676 0.382441 -0.246431
v -0.062249 0.382441 -0.246431
v -0.062249 0.382441 -0.326989
v -0.013676 0.457150 -0.326989
v -0.013676 0.457150 -0.246431
v -0.062249 0.457150 -0.246431
v -0.062249 0.457150 -0.326989
s off
f 42 44 41
f 45 47 46
f 45 42 41
f 46 43 42
f 43 48 44
f 41 48 45
f 42 43 44
f 45 48 47
f 45 46 42
f 46 47 43
f 43 47 48
f 41 44 48
o Cube.003_Cube.006
v -0.013676 0.382441 -0.082224
v -0.013676 0.382441 -0.001666
v -0.062249 0.382441 -0.001666
v -0.062249 0.382441 -0.082224
v -0.013676 0.457150 -0.082224
v -0.013676 0.457150 -0.001666
v -0.062249 0.457150 -0.001666
v -0.062249 0.457150 -0.082224
s off
f 49 51 52
f 53 55 54
f 53 50 49
f 54 51 50
f 55 52 51
f 49 56 53
f 49 50 51
f 53 56 55
f 53 54 50
f 54 55 51
f 55 56 52
f 49 52 56
o Cylinder.001_Cylinder.003
v -0.036440 -0.115694 1.346480
v -0.036440 -0.115694 0.628038
v -0.026973 -0.111772 1.346480
v -0.026973 -0.111772 0.628038
v -0.023052 -0.102305 1.346480
v -0.023052 -0.102305 0.628038
v -0.026973 -0.092838 1.346480
v -0.026973 -0.092838 0.628038
v -0.036440 -0.088917 1.346480
v -0.036440 -0.088917 0.628038
v -0.045907 -0.092838 1.346480
v -0.045907 -0.092838 0.628038
v -0.049828 -0.102305 1.346480
v -0.049828 -0.102305 0.628038
v -0.045907 -0.111772 1.346480
v -0.045907 -0.111772 0.628038
s off
f 58 59 57
f 60 61 59
f 62 63 61
f 64 65 63
f 66 67 65
f 68 69 67
f 70 64 62
f 70 71 69
f 72 57 71
f 63 67 59
f 58 60 59
f 60 62 61
f 62 64 63
f 64 66 65
f 66 68 67
f 68 70 69
f 62 60 58
f 58 72 62
f 70 68 66
f 66 64 70
f 62 72 70
f 70 72 71
f 72 58 57
f 71 57 59
f 59 61 63
f 63 65 67
f 67 69 71
f 71 59 67
o Cylinder.003_Cylinder.005
v -0.098207 -0.051808 0.124331
v -0.055754 -0.051808 0.124331
v -0.098207 -0.004684 0.238098
v -0.055754 -0.004684 0.238098
v -0.098207 0.109083 0.285222
v -0.055754 0.109083 0.285222
v -0.098207 0.222851 0.238098
v -0.055754 0.222851 0.238098
v -0.098207 0.269974 0.124331
v -0.055754 0.269974 0.124331
v -0.098207 0.222851 0.010563
v -0.055754 0.222851 0.010563
v -0.098207 0.109083 -0.036560
v -0.055754 0.109083 -0.036560
v -0.098207 -0.004684 0.010563
v -0.055754 -0.004684 0.010563
s off
f 74 75 73
f 76 77 75
f 78 79 77
f 80 81 79
f 82 83 81
f 84 85 83
f 86 80 78
f 85 88 87
f 88 73 87
f 79 83 87
f 74 76 75
f 76 78 77
f 78 80 79
f 80 82 81
f 82 84 83
f 84 86 85
f 78 76 74
f 74 88 78
f 86 84 82
f 82 80 86
f 78 88 86
f 85 86 88
f 88 74 73
f 87 73 75
f 75 77 87
f 79 81 83
f 83 85 87
f 87 77 79
o Cylinder.002_Cylinder.006
v -0.080830 0.079905 0.124331
v -0.073131 0.079905 0.124331
v -0.080830 0.088451 0.144963
v -0.073131 0.088451 0.144963
v -0.080830 0.109083 0.153509
v -0.073131 0.109083 0.153509
v -0.080830 0.129715 0.144963
v -0.073131 0.129715 0.144963
v -0.080830 0.138262 0.124331
v -0.073131 0.138262 0.124331
v -0.080830 0.129715 0.103698
v -0.073131 0.129715 0.103698
v -0.080830 0.109083 0.095152
v -0.073131 0.109083 0.095152
v -0.080830 0.088451 0.103698
v -0.073131 0.088451 0.103698
s off
f 90 91 89
f 92 93 91
f 94 95 93
f 96 97 95
f 98 99 97
f 100 101 99
f 102 96 94
f 101 104 103
f 104 89 103
f 95 99 103
f 90 92 91
f 92 94 93
f 94 96 95
f 96 98 97
f 98 100 99
f 100 102 101
f 94 92 90
f 90 104 102
f 102 100 98
f 98 96 102
f 94 90 102
f 101 102 104
f 104 90 89
f 103 89 95
f 91 93 95
f 95 97 99
f 99 101 103
f 89 91 95
o Cylinder.005_Cylinder.008
v -0.080830 0.079905 -0.223157
v -0.073131 0.079905 -0.223157
v -0.080830 0.088451 -0.202525
v -0.073131 0.088451 -0.202525
v -0.080830 0.109083 -0.193979
v -0.073131 0.109083 -0.193979
v -0.080830 0.129715 -0.202525
v -0.073131 0.129715 -0.202525
v -0.080830 0.138262 -0.223157
v -0.073131 0.138262 -0.223157
v -0.080830 0.129715 -0.243790
v -0.073131 0.129715 -0.243790
v -0.080830 0.109083 -0.252336
v -0.073131 0.109083 -0.252336
v -0.080830 0.088451 -0.243790
v -0.073131 0.088451 -0.243790
s off
f 106 107 105
f 108 109 107
f 109 112 111
f 112 113 111
f 114 115 113
f 116 117 115
f 118 112 110
f 118 119 117
f 120 105 119
f 111 115 119
f 106 108 107
f 108 110 109
f 109 110 112
f 112 114 113
f 114 116 115
f 116 118 117
f 110 108 106
f 106 120 118
f 118 116 114
f 114 112 118
f 110 106 118
f 118 120 119
f 120 106 105
f 119 105 111
f 107 109 111
f 111 113 115
f 115 117 119
f 105 107 111
o Cylinder.004_Cylinder.007
v -0.098207 -0.051808 -0.223157
v -0.055754 -0.051808 -0.223157
v -0.098207 -0.004684 -0.109390
v -0.055754 -0.004684 -0.109390
v -0.098207 0.109083 -0.062266
v -0.055754 0.109083 -0.062266
v -0.098207 0.222851 -0.109390
v -0.055754 0.222851 -0.109390
v -0.098207 0.269974 -0.223157
v -0.055754 0.269974 -0.223157
v -0.098207 0.222851 -0.336925
v -0.055754 0.222851 -0.336925
v -0.098207 0.109083 -0.384049
v -0.055754 0.109083 -0.384049
v -0.098207 -0.004684 -0.336925
v -0.055754 -0.004684 -0.336925
s off
f 122 123 121
f 124 125 123
f 126 127 125
f 128 129 127
f 130 131 129
f 132 133 131
f 134 128 126
f 133 136 135
f 136 121 135
f 127 133 135
f 122 124 123
f 124 126 125
f 126 128 127
f 128 130 129
f 130 132 131
f 132 134 133
f 126 124 134
f 122 136 134
f 134 132 130
f 130 128 134
f 124 122 134
f 133 134 136
f 136 122 121
f 135 121 123
f 123 125 135
f 127 129 131
f 131 133 127
f 135 125 127
`;